#Java #Semaphore
### Семафор ###

2023-12-25 16:11

Семафор — это средство для синхронизации доступа к какому-то ресурсу. **Его особенность заключается в том, что при создании механизма синхронизации он использует счетчик.** Счетчик указывает нам, сколько потоков одновременно могут получать доступ к общему ресурсу.

Семафоры в Java представлены классом Semaphore. При создании объектов-семафоров мы можем использовать такие конструкторы:
```java
Semaphore(int permits)
Semaphore(int permits, boolean fair)
```
В конструктор мы передаем:
- **`int permits`** — начальное и максимальное значение счетчика. То есть то, сколько потоков одновременно могут иметь доступ к общему ресурсу;  
- **`boolean fair`** — для установления порядка, в котором потоки будут получать доступ. Если `fair` = _true_, доступ предоставляется ожидающим потокам в том порядке, в котором они его запрашивали. Если же он равен _false_, порядок будет определять планировщик потоков.

Классический пример использования семафоров — [задача об обедающих философах](https://ru.wikipedia.org/wiki/%D0%97%D0%B0%D0%B4%D0%B0%D1%87%D0%B0_%D0%BE%D0%B1_%D0%BE%D0%B1%D0%B5%D0%B4%D0%B0%D1%8E%D1%89%D0%B8%D1%85_%D1%84%D0%B8%D0%BB%D0%BE%D1%81%D0%BE%D1%84%D0%B0%D1%85).

Представь, что у нас есть 5 философов, которым нужно пообедать. При этом у нас есть один стол, и одновременно находиться за ним могут не более двух человек. Наша задача — накормить всех философов. Никто из них не должен остаться голодным, и при этом они не должны «заблокировать» друг друга при попытке сесть за стол (мы должны избежать deadlock). 

Вот как будет выглядеть наш класс философа:
```java
class Philosopher extends Thread {
   private Semaphore sem;
   // поел ли философ
   private boolean full = false;
   private String name;

   Philosopher(Semaphore sem, String name) {
       this.sem=sem;
       this.name=name;
   }

   public void run()
   {
       try
       {
           // если философ еще не ел
           if (!full) {
               //Запрашиваем у семафора разрешение на выполнение
               sem.acquire();
               System.out.println (name + " садится за стол");
               // философ ест
               sleep(300);
               full = true;
               System.out.println (name + " поел! Он выходит из-за стола");
               sem.release();
               // философ ушел, освободив место другим
               sleep(300);
           }
       }
       catch(InterruptedException e) {
           System.out.println ("Что-то пошло не так!");
       }
   }
}
```
А вот код для запуска нашей программы:
```java
public class Main {

   public static void main(String[] args) {
       Semaphore sem = new Semaphore(2);
       
       new Philosopher(sem,"Сократ").start();
       new Philosopher(sem,"Платон").start();
       new Philosopher(sem,"Аристотель").start();
       new Philosopher(sem,"Фалес").start();
       new Philosopher(sem,"Пифагор").start();
   }
}
```
Мы создали семафор со счетчиком 2, чтобы соответствовать условию, одновременно есть могут только два философа. То есть, одновременно работать могут только два потока, ведь наш класс Philosopher унаследован от [Thread](Thread).

Методы acquire() и release() класса Semaphore управляют его счетчиком разрешений. Метод acquire() запрашивает разрешение на доступ к ресурсу у семафора. Если счетчик > 0, разрешение предоставляется, а счетчик уменьшается на 1. Метод release() «освобождает» выданное ранее разрешение и возвращает его в счетчик (увеличивает счетчик разрешений семафора на 1).

Вот какой вывод в консоль мы получили:
<p style="background-color: navy; color: yellow">Сократ садится за стол<br>
Платон садится за стол<br>
Сократ поел! Он выходит из-за стола<br>
Платон поел! Он выходит из-за стола<br>
Аристотель садится за стол<br>
Пифагор садится за стол<br>
Аристотель поел! Он выходит из-за стола<br>
Пифагор поел! Он выходит из-за стола<br>
Фалес садится за стол<br>
Фалес поел! Он выходит из-за стола</p>
Можно заметить некоторое сходство между [мьютексом](Mutex) и семафором. У них, в общем-то, одинаковое предназначение: синхронизировать доступ к какому-то ресурсу.

Разница только в том, что [мьютекс](Mutex) объекта может захватить одновременно только один поток, а в случае с семафором используется счетчик потоков, и доступ к ресурсу могут получить сразу несколько из них. 
И это не просто случайное сходство. На самом деле **[мьютекс](Mutex) — это одноместный семафор**. То есть, это семафор, счетчик которого изначально установлен в значении 1. Его еще называют «двоичным семафором», поскольку его счетчик может иметь только 2 значения — 1 («свободно») и 0 («занято»).
